<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agent IA - Brief Creator</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", sans-serif;
        background: linear-gradient(
          135deg,
          #f8f9fa 0%,
          #e9ecef 50%,
          #dee2e6 100%
        );
        color: #212529;
        line-height: 1.5;
        min-height: 100vh;
        position: relative;
      }

      body::before {
        content: "";
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
            ellipse 1200px 400px at 10% 30%,
            rgba(180, 180, 180, 0.06) 0%,
            rgba(200, 200, 200, 0.03) 40%,
            transparent 70%
          ),
          radial-gradient(
            ellipse 800px 1000px at 90% 70%,
            rgba(160, 160, 160, 0.08) 0%,
            rgba(140, 140, 140, 0.04) 35%,
            transparent 65%
          ),
          radial-gradient(
            ellipse 4px 2px at 22% 32%,
            rgba(255, 255, 255, 0.4) 0%,
            transparent 100%
          ),
          radial-gradient(
            ellipse 2px 3px at 78% 45%,
            rgba(0, 0, 0, 0.25) 0%,
            transparent 100%
          );

        pointer-events: none;
        z-index: -1;
        animation: organicFloat 25s ease-in-out infinite;
      }

      @keyframes organicFloat {
        0%,
        100% {
          transform: translateY(0px) translateX(0px) rotate(0deg) scale(1);
        }
        50% {
          transform: translateY(-10px) translateX(2px) rotate(0.5deg)
            scale(0.99);
        }
      }

      /* Header */
      .header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        padding: 16px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .logo {
        font-size: 20px;
        font-weight: 600;
        color: #000;
      }

      .header-actions {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .view-templates-btn {
        background: rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0, 0, 0, 0.1);
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        color: rgba(0, 0, 0, 0.7);
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
      }

      .view-templates-btn:hover {
        background: rgba(0, 0, 0, 0.08);
        color: #000;
      }

      .credits-btn {
        background: linear-gradient(
          135deg,
          #ffffff 0%,
          #f8f9fa 50%,
          #e9ecef 100%
        );
        border: 1px solid rgba(0, 0, 0, 0.1);
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        color: #495057;
        cursor: pointer;
        transition: all 0.2s;
      }

      .connection-status {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(0, 0, 0, 0.1);
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 12px;
        color: #495057;
        display: none;
      }

      .connection-status.connected {
        background: rgba(40, 167, 69, 0.1);
        color: #28a745;
        border-color: rgba(40, 167, 69, 0.2);
        display: block;
      }

      .connection-status.error {
        background: rgba(220, 53, 69, 0.1);
        color: #dc3545;
        border-color: rgba(220, 53, 69, 0.2);
        display: block;
      }

      /* Main Container */
      .container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 32px 24px;
      }

      .page-title {
        font-size: 28px;
        font-weight: 600;
        color: #000;
        margin-bottom: 8px;
      }

      .page-subtitle {
        font-size: 14px;
        color: rgba(0, 0, 0, 0.6);
        margin-bottom: 32px;
      }

      /* Connection Form */
      .connection-form {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(0, 0, 0, 0.06);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .form-row {
        display: flex;
        gap: 12px;
        align-items: end;
        flex-wrap: wrap;
      }

      .form-group {
        flex: 1;
        min-width: 200px;
      }

      .form-group label {
        display: block;
        font-weight: 500;
        margin-bottom: 6px;
        font-size: 13px;
        color: rgba(0, 0, 0, 0.7);
      }

      .form-group input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 6px;
        font-size: 13px;
        background: rgba(255, 255, 255, 0.9);
        transition: all 0.2s;
      }

      .form-group input:focus {
        outline: none;
        border-color: rgba(0, 0, 0, 0.2);
        background: rgba(255, 255, 255, 1);
      }

      .connect-btn {
        background: linear-gradient(135deg, #000000 0%, #343a40 100%);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }

      .connect-btn:hover {
        background: linear-gradient(135deg, #212529 0%, #495057 100%);
        transform: translateY(-1px);
      }

      .connect-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      /* Filters */
      .filters-section {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(0, 0, 0, 0.06);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .filters-row {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }

      .filter-select {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 13px;
        color: rgba(0, 0, 0, 0.7);
        cursor: pointer;
        transition: all 0.2s;
        min-width: 140px;
      }

      .filter-select:hover {
        background: rgba(255, 255, 255, 1);
        border-color: rgba(0, 0, 0, 0.2);
      }

      .search-box {
        display: flex;
        align-items: center;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 6px;
        padding: 8px 12px;
        min-width: 200px;
      }

      .search-input {
        border: none;
        outline: none;
        background: transparent;
        font-size: 13px;
        flex: 1;
        color: rgba(0, 0, 0, 0.8);
      }

      .search-input::placeholder {
        color: rgba(0, 0, 0, 0.4);
      }

      /* Table Container */
      .table-container {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(0, 0, 0, 0.06);
        border-radius: 8px;
        overflow: hidden;
        display: none;
      }

      .table-container.visible {
        display: block;
      }

      /* Table */
      .table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      .table thead {
        background: rgba(248, 249, 250, 0.9);
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      }

      .table th {
        padding: 12px 16px;
        text-align: left;
        font-weight: 600;
        color: rgba(0, 0, 0, 0.7);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 11px;
      }

      .table td {
        padding: 12px 16px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.04);
        vertical-align: middle;
      }

      .table tbody tr:hover {
        background: rgba(0, 0, 0, 0.02);
      }

      .table tbody tr:last-child td {
        border-bottom: none;
      }

      /* Table Cells */
      .page-info {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .page-icon {
        width: 24px;
        height: 24px;
        background: linear-gradient(
          135deg,
          #ffffff 0%,
          #f1f3f4 50%,
          #e8eaed 100%
        );
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        flex-shrink: 0;
      }

      .page-details {
        min-width: 0;
      }

      .page-title-cell {
        font-weight: 500;
        color: #000;
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 250px;
      }

      .page-url {
        font-size: 11px;
        color: rgba(0, 0, 0, 0.5);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 200px;
      }

      .template-badge {
        background: rgba(0, 0, 0, 0.05);
        color: rgba(0, 0, 0, 0.7);
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
        white-space: nowrap;
      }

      .template-badge.blog {
        background: rgba(255, 193, 7, 0.1);
        color: #856404;
      }
      .template-badge.sejour {
        background: rgba(23, 162, 184, 0.1);
        color: #0c5460;
      }
      .template-badge.produit {
        background: rgba(40, 167, 69, 0.1);
        color: #155724;
      }
      .template-badge.landing {
        background: rgba(220, 53, 69, 0.1);
        color: #721c24;
      }
      .template-badge.page {
        background: rgba(108, 117, 125, 0.1);
        color: #495057;
      }

      .status-badge {
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
        white-space: nowrap;
      }

      .status-published {
        background: rgba(40, 167, 69, 0.1);
        color: #28a745;
      }

      .status-draft {
        background: rgba(255, 193, 7, 0.1);
        color: #ffc107;
      }

      .brief-status {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .brief-indicator {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        flex-shrink: 0;
      }

      .brief-indicator.generated {
        background: #28a745;
      }

      .brief-indicator.pending {
        background: #ffc107;
      }

      .brief-text {
        font-size: 11px;
        color: rgba(0, 0, 0, 0.6);
      }

      .generate-btn {
        background: linear-gradient(135deg, #000000 0%, #343a40 100%);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }

      .generate-btn:hover {
        background: linear-gradient(135deg, #212529 0%, #495057 100%);
        transform: translateY(-1px);
      }

      .generate-btn.generated {
        background: rgba(40, 167, 69, 0.1);
        color: #28a745;
        cursor: default;
        transform: none;
      }

      .generate-btn.generating {
        background: linear-gradient(135deg, #6c757d 0%, #adb5bd 100%);
        cursor: not-allowed;
        animation: pulse 1.5s infinite;
      }

      .read-brief-btn {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }

      .read-brief-btn:hover {
        background: linear-gradient(135deg, #138496 0%, #117a8b 100%);
        transform: translateY(-1px);
      }

      .download-brief-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }

      .download-brief-btn:hover {
        background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);
        transform: translateY(-1px);
      }

      .timestamp {
        font-size: 11px;
        color: rgba(0, 0, 0, 0.5);
        white-space: nowrap;
      }

      /* Pagination */
      .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        background: rgba(248, 249, 250, 0.8);
        border-top: 1px solid rgba(0, 0, 0, 0.06);
      }

      .pagination-info {
        font-size: 12px;
        color: rgba(0, 0, 0, 0.6);
      }

      .pagination-controls {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .pagination-btn {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(0, 0, 0, 0.1);
        padding: 6px 10px;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .pagination-btn:hover {
        background: rgba(0, 0, 0, 0.05);
      }

      .pagination-btn.active {
        background: #000;
        color: white;
      }

      .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      /* Loading state */
      .loading-state {
        text-align: center;
        padding: 60px 20px;
        color: rgba(0, 0, 0, 0.6);
      }

      .spinner {
        display: inline-block;
        width: 32px;
        height: 32px;
        border: 3px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top-color: #000;
        animation: spin 1s ease-in-out infinite;
        margin-bottom: 16px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Responsive */
      @media (max-width: 1200px) {
        .table {
          font-size: 12px;
        }

        .table th,
        .table td {
          padding: 10px 12px;
        }

        .page-title-cell {
          max-width: 200px;
        }
      }

      @media (max-width: 768px) {
        .filters-row {
          flex-direction: column;
          align-items: stretch;
        }

        .filter-select,
        .search-box {
          min-width: auto;
        }

        .table-container {
          overflow-x: auto;
        }

        .table {
          min-width: 800px;
        }

        .form-row {
          flex-direction: column;
        }

        .form-group {
          min-width: auto;
        }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="logo">🌍 CERCLE DES VOYAGES</div>
      <div class="header-actions">
        <div id="connection-status-header" class="connection-status">
          Connecté à WordPress
        </div>
      </div>
    </header>

    <!-- Main Container -->
    <div class="container">
      <!-- Connection Form -->
      <div class="connection-form" id="connection-form">
        <h2 style="margin-bottom: 16px; font-size: 18px">
          Connexion WordPress
        </h2>
        <div class="form-row">
          <div class="form-group">
            <label for="username">Nom d'utilisateur</label>
            <input
              type="text"
              id="username"
              value="remi.segura"
              placeholder="admin"
            />
          </div>
          <div class="form-group">
            <label for="password">Mot de passe d'application</label>
            <input
              type="password"
              id="password"
              placeholder="xxxx xxxx xxxx xxxx"
            />
          </div>
          <button class="connect-btn" onclick="connectToWordPress()">
            <span id="connect-text">Se connecter</span>
          </button>
        </div>
      </div>

      <!-- Main Dashboard -->
      <div id="main-dashboard" style="display: none">
        <h1 class="page-title">Toutes les pages</h1>
        <p class="page-subtitle">
          Gérez et générez des briefs pour l'ensemble de vos pages
        </p>

        <!-- Filters -->
        <div class="filters-section">
          <div class="filters-row">
            <select
              class="filter-select"
              id="template-filter"
              onchange="filterPages()"
            >
              <option value="">Tous les templates</option>
              <option value="blog">Blog</option>
              <option value="sejour">Séjour</option>
              <option value="produit">Produit</option>
              <option value="landing">Landing</option>
              <option value="page">Page</option>
            </select>

            <select
              class="filter-select"
              id="brief-filter"
              onchange="filterPages()"
            >
              <option value="">Tous les briefs</option>
              <option value="generated">✅ Créés</option>
            </select>

            <div class="search-box">
              <input
                type="text"
                class="search-input"
                id="search-input"
                placeholder="Rechercher une page..."
                onkeyup="filterPages()"
              />
              <span>🔍</span>
            </div>
          </div>
        </div>

        <!-- Table -->
        <div class="table-container" id="table-container">
          <div class="loading-state" id="loading-state">
            <div class="spinner"></div>
            <p>Chargement des pages WordPress...</p>
          </div>

          <table class="table" id="pages-table" style="display: none">
            <thead>
              <tr>
                <th style="width: 350px">Page</th>
                <th style="width: 100px">Template</th>
                <th style="width: 120px">Brief</th>
                <th style="width: 120px">Action</th>
                <th style="width: 100px">Mise à jour</th>
              </tr>
            </thead>
            <tbody id="pages-tbody">
              <!-- Les pages seront ajoutées dynamiquement -->
            </tbody>
          </table>

          <!-- Pagination -->
          <div class="pagination" id="pagination">
            <div class="pagination-info" id="pagination-info">
              Affichage 1-10 sur 0 pages
            </div>
            <div class="pagination-controls">
              <button
                class="pagination-btn"
                onclick="changePage(-1)"
                id="prev-btn"
                disabled
              >
                ◀ Précédent
              </button>
              <button class="pagination-btn active" onclick="changePage(0)">
                1
              </button>
              <button
                class="pagination-btn"
                onclick="changePage(1)"
                id="next-btn"
              >
                Suivant ▶
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Configuration
      const wpUrl = "https://www.cercledesvoyages.com";
      const apiUrl = "https://cercledesvoyages.larefonte.store/api"; // API MongoDB
      let authHeader = null;
      let allPages = [];
      let filteredPages = [];
      let briefsData = {}; // Stockage des données MongoDB
      let currentPage = 1;
      let itemsPerPage = 10;

      // Connexion à WordPress
      async function connectToWordPress() {
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();

        if (!username || !password) {
          alert("Veuillez remplir tous les champs");
          return;
        }

        const btn = document.querySelector(".connect-btn");
        const text = document.getElementById("connect-text");

        btn.disabled = true;
        text.textContent = "Connexion...";

        try {
          authHeader = btoa(`${username}:${password}`);

          const response = await fetch(
            `${wpUrl}/wp-json/wp/v2/posts?per_page=1`,
            {
              headers: {
                Authorization: `Basic ${authHeader}`,
                "Content-Type": "application/json",
              },
            }
          );

          if (!response.ok) {
            throw new Error(
              `Erreur ${response.status}: ${response.statusText}`
            );
          }

          // Connexion réussie
          document
            .getElementById("connection-status-header")
            .classList.add("connected");
          document.getElementById("connection-form").style.display = "none";
          document.getElementById("main-dashboard").style.display = "block";
          document.getElementById("table-container").classList.add("visible");

          // Charger les pages
          await loadAllPages();
        } catch (error) {
          alert(`Erreur de connexion: ${error.message}`);
          authHeader = null;
        } finally {
          btn.disabled = false;
          text.textContent = "Se connecter";
        }
      }

      // Charger toutes les pages WordPress
      async function loadAllPages() {
        try {
          document.getElementById("loading-state").style.display = "block";
          document.getElementById("pages-table").style.display = "none";

          // D'abord, découvrir tous les types de posts disponibles
          const typesResponse = await fetch(`${wpUrl}/wp-json/wp/v2/types`, {
            headers: {
              Authorization: `Basic ${authHeader}`,
              "Content-Type": "application/json",
            },
          });

          const postTypes = await typesResponse.json();
          console.log("Types de posts découverts:", postTypes);
          console.log("Types disponibles:", Object.keys(postTypes));

          // Récupérer les contenus pour chaque type de post
          const allContentPromises = [];

          for (const [typeKey, typeData] of Object.entries(postTypes)) {
            // Ignorer les types système
            if (
              [
                "attachment",
                "revision",
                "nav_menu_item",
                "custom_css",
                "customize_changeset",
                "oembed_cache",
              ].includes(typeKey)
            ) {
              continue;
            }

            const endpoint = typeData.rest_base || typeKey;

            allContentPromises.push(
              fetch(`${wpUrl}/wp-json/wp/v2/${endpoint}?per_page=100`, {
                headers: {
                  Authorization: `Basic ${authHeader}`,
                  "Content-Type": "application/json",
                },
              })
                .then(async (response) => {
                  if (response.ok) {
                    const content = await response.json();
                    return content.map((item) => ({
                      ...item,
                      wordpress_type: typeKey,
                      type_label: typeData.name,
                      rest_base: typeData.rest_base || typeKey,
                      template: mapPostTypeToTemplate(typeKey),
                    }));
                  }
                  return [];
                })
                .catch((error) => {
                  console.warn(`Erreur pour le type ${typeKey}:`, error);
                  return [];
                })
            );
          }

          // Attendre toutes les requêtes
          const allContentArrays = await Promise.all(allContentPromises);

          // Combiner tous les contenus
          allPages = allContentArrays.flat();

          console.log(
            "Pages chargées par type:",
            allPages.reduce((acc, page) => {
              acc[page.wordpress_type] = (acc[page.wordpress_type] || 0) + 1;
              return acc;
            }, {})
          );

          filteredPages = [...allPages];
          updateTemplateFilter();

          // Charger les données de briefs depuis MongoDB
          await loadBriefsFromMongoDB();

          renderPages();

          document.getElementById("loading-state").style.display = "none";
          document.getElementById("pages-table").style.display = "table";
        } catch (error) {
          console.error("Erreur détaillée:", error);
          document.getElementById("loading-state").innerHTML = `
                          <p style="color: #dc3545;">Erreur lors du chargement: ${error.message}</p>
                          <button onclick="loadAllPages()" style="margin-top: 10px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Réessayer</button>
                      `;
        }
      }

      // Mapper les types de posts WordPress vers nos templates
      function mapPostTypeToTemplate(wordpressType) {
        const typeMapping = {
          // Types natifs WordPress
          post: "blog",
          page: "page",

          // Types custom probables (à adapter selon votre site)
          sejour: "sejour",
          sejours: "sejour",
          voyage: "sejour",
          voyages: "sejour",
          destination: "sejour",
          destinations: "sejour",

          produit: "produit",
          produits: "produit",
          product: "produit",
          products: "produit",

          landing: "landing",
          "landing-page": "landing",
          landingpage: "landing",

          // Autres types possibles
          formation: "landing",
          formations: "landing",
          service: "landing",
          services: "landing",
        };

        return typeMapping[wordpressType] || wordpressType;
      }

      // Charger les données de briefs depuis MongoDB
      async function loadBriefsFromMongoDB() {
        try {
          const response = await fetch(`${apiUrl}/briefs`);
          if (response.ok) {
            const briefs = await response.json();

            // Indexer par wordpress_id pour un accès rapide
            briefsData = {};
            briefs.forEach((brief) => {
              briefsData[brief.wordpress_id] = brief;
            });

            console.log(
              "Briefs chargés depuis MongoDB:",
              Object.keys(briefsData).length
            );
          } else {
            console.warn("Impossible de charger les briefs depuis MongoDB");
          }
        } catch (error) {
          console.warn("Erreur lors du chargement des briefs:", error);
          // Continuer sans MongoDB si non disponible
        }
      }

      // Obtenir le statut d'un brief depuis MongoDB
      function getBriefStatus(wordpressId) {
        const brief = briefsData[wordpressId];
        return brief ? brief.status : "not_generated";
      }

      // Obtenir le contenu d'un brief depuis MongoDB
      function getBriefContent(wordpressId) {
        const brief = briefsData[wordpressId];
        return brief ? brief.brief_content : "";
      }
      function updateTemplateFilter() {
        const templateFilter = document.getElementById("template-filter");
        const uniqueTemplates = [
          ...new Set(allPages.map((page) => page.template)),
        ];

        // Garder l'option "Tous"
        const currentOptions = templateFilter.innerHTML;
        const allOption = currentOptions.split("\n")[1]; // Garder "Tous les templates"

        templateFilter.innerHTML =
          allOption +
          "\n" +
          uniqueTemplates
            .map((template) => {
              const name = getTemplateName(template);
              return `<option value="${template}">${name}</option>`;
            })
            .join("\n");
      }

      // Filtrer les pages
      function filterPages() {
        const templateFilter = document.getElementById("template-filter").value;
        const briefFilter = document.getElementById("brief-filter").value;
        const searchTerm = document
          .getElementById("search-input")
          .value.toLowerCase();

        filteredPages = allPages.filter((page) => {
          const matchesTemplate =
            !templateFilter || page.template === templateFilter;
          const matchesSearch =
            !searchTerm ||
            page.title.rendered.toLowerCase().includes(searchTerm) ||
            page.slug.toLowerCase().includes(searchTerm);

          // Utiliser le vrai statut depuis MongoDB
          const briefStatus = getBriefStatus(page.id);
          const matchesBrief = !briefFilter || briefStatus === briefFilter;

          return matchesTemplate && matchesSearch && matchesBrief;
        });

        currentPage = 1;
        renderPages();
      }

      // Rendre les pages dans le tableau
      function renderPages() {
        const tbody = document.getElementById("pages-tbody");
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pagesToShow = filteredPages.slice(startIndex, endIndex);

        tbody.innerHTML = pagesToShow
          .map((page, index) => {
            // Utiliser le vrai statut depuis MongoDB
            const briefStatus = getBriefStatus(page.id);

            return `
                          <tr>
                              <td>
                                  <div class="page-info">

                                      <div class="page-details">
                                          <div class="page-title-cell">${
                                            page.title.rendered
                                          }</div>
                                          <div class="page-url">${page.link
                                            .replace("https://", "")
                                            .substring(
                                              0,
                                              40
                                            )}... <small style="color: #999;">(${
              page.wordpress_type
            })</small></div>
                                      </div>
                                  </div>
                              </td>
                              <td><span class="template-badge ${
                                page.template
                              }">${getTemplateName(page.template)}</span></td>
                              <td>
                                  <div class="brief-status">
                                      <div class="brief-indicator ${briefStatus}"></div>
                                      <span class="brief-text">${
                                        briefStatus === "generated"
                                          ? "Créé"
                                          : "À générer"
                                      }</span>
                                  </div>
                              </td>
                              <td>
                                  ${
                                    briefStatus === "generated"
                                      ? `<div style="display: flex; gap: 4px; flex-direction: column;">
                                           <button class="generate-btn generated" disabled>✓ Brief créé</button>
                                           <div style="display: flex; gap: 4px;">
                                             <button class="read-brief-btn" onclick="readBrief(${page.id}, '${page.title.rendered}')">📖 Lire</button>
                                             <button class="download-brief-btn" onclick="downloadBrief(${page.id}, '${page.title.rendered}')">💾 Télécharger</button>
                                           </div>
                                         </div>`
                                      : `<button class="generate-btn"
                                                onclick="generateBrief(this, '${
                                                  page.template
                                                }', '${page.title.rendered}', ${
                                          page.id
                                        })">
                                           ${
                                             briefStatus === "processing"
                                               ? "⏳ Génération..."
                                               : "Générer le brief"
                                           }
                                         </button>`
                                  }
                              </td>
                              <td><span class="timestamp">${getTimeAgo(
                                page.modified
                              )}</span></td>
                          </tr>
                      `;
          })
          .join("");

        updatePagination();
      }

      function getTemplateName(template) {
        const names = {
          blog: "Blog",
          sejour: "Séjour",
          produit: "Produit",
          landing: "Landing",
          page: "Page",
          post: "Article",

          // Noms pour types custom potentiels
          voyage: "Voyage",
          voyages: "Voyages",
          destination: "Destination",
          destinations: "Destinations",
          formation: "Formation",
          formations: "Formations",
          service: "Service",
          services: "Services",
        };
        return (
          names[template] ||
          template.charAt(0).toUpperCase() + template.slice(1)
        );
      }

      function getTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffInSeconds = Math.floor((now - date) / 1000);

        if (diffInSeconds < 60) return "il y a 1m";
        if (diffInSeconds < 3600)
          return `il y a ${Math.floor(diffInSeconds / 60)}m`;
        if (diffInSeconds < 86400)
          return `il y a ${Math.floor(diffInSeconds / 3600)}h`;
        return `il y a ${Math.floor(diffInSeconds / 86400)}j`;
      }

      function updatePagination() {
        const totalPages = Math.ceil(filteredPages.length / itemsPerPage);
        const startItem = (currentPage - 1) * itemsPerPage + 1;
        const endItem = Math.min(
          currentPage * itemsPerPage,
          filteredPages.length
        );

        document.getElementById(
          "pagination-info"
        ).textContent = `Affichage ${startItem}-${endItem} sur ${filteredPages.length} pages`;

        document.getElementById("prev-btn").disabled = currentPage === 1;
        document.getElementById("next-btn").disabled =
          currentPage === totalPages;
      }

      function changePage(direction) {
        const totalPages = Math.ceil(filteredPages.length / itemsPerPage);

        if (direction === -1 && currentPage > 1) {
          currentPage--;
        } else if (direction === 1 && currentPage < totalPages) {
          currentPage++;
        }

        renderPages();
      }

      // Générer un brief
      async function generateBrief(
        button,
        templateType,
        pageTitle,
        wordpressId
      ) {
        const row = button.closest("tr");
        const briefStatus = row.querySelector(".brief-status");
        const briefIndicator = briefStatus.querySelector(".brief-indicator");
        const briefText = briefStatus.querySelector(".brief-text");

        // Animation de début
        button.textContent = "Génération...";
        button.classList.add("generating");
        button.disabled = true;
        row.style.background = "rgba(0, 0, 0, 0.02)";

        try {
          // Récupérer l'URL de la page
          const page = allPages.find((p) => p.id === wordpressId);
          if (!page || !page.link) {
            throw new Error("URL de la page introuvable");
          }

          button.textContent = "Création du brief...";

          // Appeler votre route POST qui validera avec n8n
          const response = await fetch(`${apiUrl}/briefs`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              url: page.link,
              wordpress_id: wordpressId,
              title: pageTitle,
              rest_base: page.rest_base,
              wordpress_type: page.wordpress_type,
              slug: page.slug,
              source_type: "wordpress",
              status: "pending",
            }),
          });

          const result = await response.json();

          if (result.success) {
            // Brief créé avec succès
            button.textContent = "✓ Brief créé";
            button.classList.remove("generating");
            button.classList.add("generated");

            briefIndicator.classList.remove("pending");
            briefIndicator.classList.add("generated");
            briefText.textContent = "Créé";

            // Mettre à jour le cache local
            briefsData[wordpressId] = result.brief;

            // Recharger la ligne pour afficher le bouton "Lire le brief"
            setTimeout(() => {
              renderPages(); // Recharger le tableau pour afficher le nouveau bouton

              let message = `✅ Brief créé avec succès pour "${pageTitle}"!\n\n`;
              message += `📋 Brief ID: ${result.brief_id}\n`;
              message += `🌐 URL: ${page.link}\n\n`;
              message += `Vous pouvez maintenant lire le brief en cliquant sur le bouton "📖 Lire le brief".`;

              alert(message);
              row.style.background = "";
            }, 1000);
          } else {
            // Erreur de validation n8n ou autre
            throw new Error(result.error || "Erreur inconnue");
          }
        } catch (error) {
          console.error("Erreur lors de la génération:", error);

          // Gérer les différents types d'erreurs
          let errorMessage = "Erreur - Réessayer";
          let alertMessage = `❌ Erreur lors de la génération du brief pour "${pageTitle}":\n\n`;

          if (error.message.includes("URL")) {
            errorMessage = "URL invalide";
            alertMessage += `🌐 Problème d'URL: ${error.message}`;
          } else if (error.message.includes("validation")) {
            errorMessage = "Validation échouée";
            alertMessage += `⚠️ Problème de validation: ${error.message}`;
          } else {
            alertMessage += `⚠️ ${error.message}`;
          }

          button.textContent = errorMessage;
          button.classList.remove("generating");
          button.disabled = false;
          row.style.background = "";

          alert(alertMessage);
        }
      }

      function getBriefContentTemplate(templateType, pageTitle) {
        const briefs = {
          blog: `BRIEF ARTICLE BLOG\n"${pageTitle}"\n\n• Hook d'introduction percutant\n• Structure H2/H3 optimisée SEO\n• 1500-2000 mots minimum\n• Call-to-action en fin d'article\n• Méta description 155 caractères\n• Suggestions d'images illustratives`,
          sejour: `BRIEF PAGE SÉJOUR\n"${pageTitle}"\n\n• Titre accrocheur + localisation\n• Galerie photos haute résolution\n• Description immersive des atouts\n• Informations pratiques détaillées\n• Témoignages clients authentiques\n• Bouton réservation visible`,
          produit: `BRIEF FICHE PRODUIT\n"${pageTitle}"\n\n• Titre produit + référence\n• Photos produit multi-angles\n• Description bénéfices utilisateur\n• Caractéristiques techniques\n• Prix et disponibilité\n• Avis clients notation`,
          landing: `BRIEF LANDING PAGE\n"${pageTitle}"\n\n• Hook problème/solution\n• Proposition de valeur unique\n• Bénéfices en bullet points\n• Preuves sociales (logos, témoignages)\n• CTA principal au-dessus de la ligne de flottaison\n• Formulaire de conversion optimisé`,
          page: `BRIEF PAGE STANDARD\n"${pageTitle}"\n\n• Titre clair et informatif\n• Structure logique et hiérarchisée\n• Contenu pertinent et à jour\n• Navigation intuitive\n• Optimisation SEO de base\n• Call-to-action approprié`,
        };

        return briefs[templateType] || `Brief généré pour "${pageTitle}"`;
      }

      // Fonction pour décoder le Base64 en UTF-8 correctement
      function decodeBase64ToUTF8(base64String) {
        try {
          // Décoder le Base64 en binaire
          const binaryString = atob(base64String);

          // Convertir chaque caractère en octets
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }

          // Décoder les octets en UTF-8
          const decoder = new TextDecoder("utf-8");
          return decoder.decode(bytes);
        } catch (error) {
          console.error("Erreur lors du décodage Base64 UTF-8:", error);
          // Fallback vers atob() standard
          return atob(base64String);
        }
      }

      // Lire un brief dans une nouvelle fenêtre
      async function readBrief(wordpressId, pageTitle) {
        try {
          // Récupérer le brief depuis l'API
          const response = await fetch(`${apiUrl}/briefs/${wordpressId}`);

          if (!response.ok) {
            throw new Error(`Erreur ${response.status}: Brief non trouvé`);
          }

          const brief = await response.json();

          if (!brief.brief_html_base64) {
            alert("Aucun contenu de brief disponible pour cette page.");
            return;
          }

          // Décoder le Base64 pour obtenir le HTML avec support UTF-8
          const decodedHtml = decodeBase64ToUTF8(brief.brief_html_base64);

          // Ouvrir une nouvelle fenêtre avec le contenu du brief (HTML complet)
          const newWindow = window.open(
            "",
            "_blank",
            "width=1200,height=800,scrollbars=yes,resizable=yes"
          );

          if (newWindow) {
            newWindow.document.write(decodedHtml);
            newWindow.document.close();
            newWindow.focus();
          } else {
            alert(
              "Impossible d'ouvrir une nouvelle fenêtre. Vérifiez que les pop-ups ne sont pas bloquées."
            );
          }
        } catch (error) {
          console.error("Erreur lors de la lecture du brief:", error);
          alert(`Erreur lors de la lecture du brief: ${error.message}`);
        }
      }

      // Télécharger un brief en tant que fichier HTML
      async function downloadBrief(wordpressId, pageTitle) {
        try {
          // Récupérer le brief depuis l'API
          const response = await fetch(`${apiUrl}/briefs/${wordpressId}`);

          if (!response.ok) {
            throw new Error(`Erreur ${response.status}: Brief non trouvé`);
          }

          const brief = await response.json();

          if (!brief.brief_html_base64) {
            alert("Aucun contenu de brief disponible pour cette page.");
            return;
          }

          // Décoder le Base64 pour obtenir le HTML avec support UTF-8
          const decodedHtml = decodeBase64ToUTF8(brief.brief_html_base64);

          // Créer le nom du fichier (nettoyer le titre pour éviter les caractères interdits)
          const fileName = `brief_${pageTitle
            .replace(/[^\w\s-]/g, "")
            .replace(/\s+/g, "_")}.html`;

          // Créer un blob avec le contenu HTML (directement le HTML décodé)
          const blob = new Blob([decodedHtml], {
            type: "text/html;charset=utf-8",
          });

          // Créer un lien de téléchargement
          const link = document.createElement("a");
          link.href = URL.createObjectURL(blob);
          link.download = fileName;

          // Ajouter temporairement le lien au DOM et le cliquer
          document.body.appendChild(link);
          link.click();

          // Nettoyer
          document.body.removeChild(link);
          URL.revokeObjectURL(link.href);

          console.log(`Brief téléchargé: ${fileName}`);
        } catch (error) {
          console.error("Erreur lors du téléchargement du brief:", error);
          alert(`Erreur lors du téléchargement du brief: ${error.message}`);
        }
      }

      function showTemplatesView() {
        alert(
          "Vue Templates :\n\n📝 Template Blog\n🏨 Template Séjour\n🛍️ Template Produit\n📄 Template Landing\n📃 Template Page\n\nFonctionnalité en développement..."
        );
      }

      // Initialisation
      document.addEventListener("DOMContentLoaded", function () {
        document.addEventListener("keypress", function (e) {
          if (e.key === "Enter" && e.target.matches("#username, #password")) {
            connectToWordPress();
          }
        });
      });
    </script>
  </body>
</html>
